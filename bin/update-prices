#!/usr/bin/env node

const config = require('../config')
const mongoose = require('mongoose')
const dayjs = require('dayjs')
const utc = require('dayjs/plugin/utc')
const fs = require('fs')
const scraper = require('tsp-scraper')
const Daily = require('../models/daily')

dayjs.extend(utc)

console.log('Database:', config.mongoUrl)

mongoose.connect(config.mongoUrl, async (err, db) => {
  let latestPrices
  const lastArg = process.argv.at(-1)
  if (lastArg.match(/\.json$/)) {
    console.log('Reading prices from file:', lastArg)
    latestPrices = JSON.parse(fs.readFileSync(lastArg))
  } else {
    console.log('Scraping prices from TSP')
    latestPrices = await scraper.scrape()
  }

  for (dailyPrices of latestPrices) {
    const updatedDaily = await Daily.findOneAndUpdate({ date: dailyPrices.date }, dailyPrices, { upsert: true })
    if (updatedDaily === null) {
      console.log('Creating', dayjs.utc(dailyPrices.date).format("YYYY-MM-DD"))
    } else {
      console.log('Updating', dayjs.utc(updatedDaily.date).format("YYYY-MM-DD"))
    }
  }

  mongoose.connection.close()
})
